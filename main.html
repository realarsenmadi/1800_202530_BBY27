<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SureSpot</title>
    <meta name="comp1800 template" content="My 1800 App" />

    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- MapLibre GL JS -->
    <link
      href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

    <!-- Link to your styles -->
    <link rel="stylesheet" href="./styles/style.css" />
  </head>

  <body class="main-page">
    <!-- Navigation bar -->
    <nav class="navbar">
      <div></div>
      <div>
        <a href="#">
          <img src="./images/home_icon.png" alt="Home Icon" class="home-icon" />
        </a>
      </div>
    </nav>

    <!-- ========== ADDED: Parking Availability Legend ========== -->
    <div class="parking-legend">
      <div class="legend-title">Parking Status</div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #22c55e"></div>
        <span>Available</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #ef4444"></div>
        <span>Full</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #f59e0b"></div>
        <span>Closed</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #808080"></div>
        <span>No Data</span>
      </div>
    </div>
    <!-- ========== END ADDED ========== -->

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Filters, My Location & Search (floating above map) -->
    <div class="search-functions">
      <!-- Filters -->
      <div>
        <img src="./images/Filters.png" alt="Filter Icon" class="filter-icon" />
      </div>

      <!-- üìç My Location -->
      <div>
        <img
          src="./images/Location.png"
          alt="My Location Button"
          class="location-button"
          id="locateBtn"
        />
      </div>

      <!-- Search -->
      <div>
        <img
          src="./images/Search.png"
          alt="Search Button"
          class="search-button"
          id="searchBtn"
        />
      </div>
    </div>

    <!-- Search Modal -->
    <div id="searchModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Search Location</h3>
          <button id="closeModal">&times;</button>
        </div>

        <div class="search-input-container">
          <input
            type="text"
            id="locationInput"
            placeholder="Enter address or place name..."
          />
        </div>

        <div id="searchResults"></div>
      </div>
    </div>

    <!-- ========== ADDED: Parking Report Modal ========== -->
    <div id="reportModal" class="report-modal">
      <div class="report-modal-content">
        <button id="closeReportModal" class="close-report-btn">&times;</button>
        <h3 class="report-modal-title">üÖøÔ∏è Parking Availability</h3>
        <p id="modalLocationName" class="report-modal-text">
          Are there parking spots available here?
        </p>
        <div class="report-button-group">
          <button
            onclick="submitReport('available')"
            class="report-button available"
          >
            ‚úÖ Available
          </button>
          <button onclick="submitReport('full')" class="report-button full">
            ‚ùå Full
          </button>
        </div>
      </div>
    </div>
    <!-- ========== END ADDED ========== -->

    <!-- Footer -->
    <footer class="footer">
      <nav class="bottom-nav">
        <div>
          <a href="profile.html">
            <img
              src="./images/Profile.png"
              alt="Profile Icon"
              class="profile-icon"
            />
          </a>
        </div>
        <div>
          <a href="favourites.html">
            <img
              src="./images/Favourites.png"
              alt="Favourites Icon"
              class="favourites-icon"
            />
          </a>
        </div>
        <div>
          <a href="faq.html">
            <img src="./images/Help.png" alt="Help Icon" class="help-icon" />
          </a>
        </div>
      </nav>
    </footer>

    <!-- JavaScript -->
    <script>
      // Wait for DOM to be fully loaded
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM loaded, initializing map...");

        const map = new maplibregl.Map({
          container: "map",
          style:
            "https://api.maptiler.com/maps/streets-v2/style.json?key=G8Dm1IT5QuwmIf5bQtVr",
          center: [-123.0016, 49.2505], // BCIT Burnaby Campus
          zoom: 15,
        });

        // ========== MODIFIED: Track markers and parking data ==========
        let userMarker = null;
        let searchMarker = null;
        let currentUserLocation = null;
        let parkingMarkers = [];
        // ========== END MODIFIED ==========

        // ========== ADDED: Define BCIT parking zones with actual coordinates ==========
        const parkingLocations = [
          {
            id: "A",
            name: "BCIT Parking Lot A",
            center: [-122.99747292626391, 49.252218801096035],
            radius: 80,
            reports: [],
          },
          {
            id: "B",
            name: "BCIT Parking Lot B",
            center: [-122.99740913222692, 49.25172744299303],
            radius: 80,
            reports: [],
          },
          {
            id: "D",
            name: "BCIT Parking Lot D",
            center: [-122.99970571760426, 49.24816286829297],
            radius: 80,
            reports: [],
          },
          {
            id: "E/F",
            name: "BCIT Parking Lot E/F",
            center: [-122.99838964985744, 49.24717712468893],
            radius: 70,
            reports: [],
            status: "closed", // Closed for construction
          },
          {
            id: "L",
            name: "BCIT Parking Lot L",
            center: [-122.99956542868452, 49.24544495669218],
            radius: 80,
            reports: [],
          },
          {
            id: "M/N",
            name: "BCIT Parking Lot M/N",
            center: [-123.0019070002376, 49.24355785029364],
            radius: 90,
            reports: [],
          },
          {
            id: "Q",
            name: "BCIT Parking Lot Q",
            center: [-123.00160493253136, 49.25446731483849],
            radius: 80,
            reports: [],
          },
          {
            id: "5",
            name: "BCIT Parking Lot 5",
            center: [-123.00056274604528, 49.25023650243376],
            radius: 70,
            reports: [],
          },
          {
            id: "7",
            name: "BCIT Parking Lot 7 (Staff)",
            center: [-122.99890272762627, 49.249023340019455],
            radius: 70,
            reports: [],
          },
          {
            id: "12",
            name: "BCIT Parking Lot 12",
            center: [-122.99929066685925, 49.24992438097292],
            radius: 70,
            reports: [],
          },
        ];
        // ========== END ADDED ==========

        // ========== ADDED: Function to get marker color based on reports ==========
        function getMarkerColor(location) {
          // If parking lot is closed, show orange
          if (location.status === "closed") {
            return "#f59e0b"; // Orange for closed
          }

          if (location.reports.length === 0) return "#808080"; // Gray - no data

          // Only consider reports from last 30 minutes
          const now = Date.now();
          const recentReports = location.reports.filter(
            (r) => now - r.timestamp < 30 * 60 * 1000
          );

          if (recentReports.length === 0) return "#808080";

          // Count report types
          const available = recentReports.filter(
            (r) => r.status === "available"
          ).length;
          const full = recentReports.filter((r) => r.status === "full").length;

          // Simple majority vote
          if (available > full) {
            return "#22c55e"; // Green - Available
          } else {
            return "#ef4444"; // Red - Full
          }
        }
        // ========== END ADDED ==========

        // ========== ADDED: Function to draw parking zones with P icons ==========
        function drawParkingZones() {
          map.on("load", () => {
            // Add sources and layers for each parking location
            parkingLocations.forEach((location) => {
              const sourceId = `parking-${location.id}`;
              const layerId = `parking-layer-${location.id}`;

              // Add source
              map.addSource(sourceId, {
                type: "geojson",
                data: {
                  type: "Feature",
                  geometry: {
                    type: "Point",
                    coordinates: location.center,
                  },
                  properties: {
                    name: location.name,
                    id: location.id,
                  },
                },
              });

              // Add circle layer for the parking icon background
              map.addLayer({
                id: layerId,
                type: "circle",
                source: sourceId,
                paint: {
                  "circle-radius": 20,
                  "circle-color": getMarkerColor(location),
                  "circle-stroke-width": 2,
                  "circle-stroke-color": "#ffffff",
                },
              });

              // Add text layer for parking lot letter/number
              map.addLayer({
                id: `${layerId}-text`,
                type: "symbol",
                source: sourceId,
                layout: {
                  "text-field": location.id,
                  "text-size": 14,
                  "text-font": ["Open Sans Bold", "Arial Unicode MS Bold"],
                },
                paint: {
                  "text-color": "#ffffff",
                },
              });

              // Add click event to show report modal (skip if closed)
              map.on("click", layerId, () => {
                if (location.status === "closed") {
                  alert(
                    `${location.name} is currently closed for construction.`
                  );
                } else {
                  showReportModal(location);
                }
              });

              // Change cursor on hover
              map.on("mouseenter", layerId, () => {
                map.getCanvas().style.cursor = "pointer";
              });

              map.on("mouseleave", layerId, () => {
                map.getCanvas().style.cursor = "";
              });

              // Store reference for updates
              parkingMarkers.push({ location, layerId });
            });
          });
        }
        // ========== END ADDED ==========

        // ========== ADDED: Function to update zone appearance after report ==========
        function updateZoneAppearance(locationId) {
          const markerObj = parkingMarkers.find(
            (m) => m.location.id === locationId
          );
          if (!markerObj) return;

          const color = getMarkerColor(markerObj.location);
          map.setPaintProperty(markerObj.layerId, "circle-color", color);
        }
        // ========== END ADDED ==========

        // ========== ADDED: Function to show report modal ==========
        function showReportModal(location) {
          document.getElementById(
            "modalLocationName"
          ).textContent = `Are parking spots available at ${location.name}?`;
          document.getElementById("reportModal").style.display = "flex";

          // Store current location for report submission
          window.currentReportLocation = location;
        }
        // ========== END ADDED ==========

        // ========== ADDED: Function to submit parking report ==========
        window.submitReport = function (status) {
          const location = window.currentReportLocation;
          if (!location) return;

          // Add report to location
          location.reports.push({
            status: status,
            timestamp: Date.now(),
            userId: "user123", // In real app, use actual user ID
          });

          // Update zone color
          updateZoneAppearance(location.id);

          // Close modal
          document.getElementById("reportModal").style.display = "none";

          // Show confirmation
          const statusText = status === "available" ? "available" : "full";
          alert(
            `Thank you! Your report (${statusText}) has been submitted for ${location.name}.`
          );

          // In real app, send to backend/database
          console.log("Report submitted:", {
            locationId: location.id,
            locationName: location.name,
            status: status,
            timestamp: Date.now(),
          });
        };
        // ========== END ADDED ==========

        // ========== ADDED: Function to check if user is near parking zones ==========
        function checkNearbyZones(userLng, userLat) {
          parkingLocations.forEach((location) => {
            // Skip closed parking lots
            if (location.status === "closed") return;

            const distance = getDistance(
              userLng,
              userLat,
              location.center[0],
              location.center[1]
            );

            // If user is within zone radius, prompt for report (only once per 10 minutes)
            if (distance < location.radius) {
              const lastPrompt = sessionStorage.getItem(
                `lastPrompt-${location.id}`
              );
              const now = Date.now();

              if (!lastPrompt || now - parseInt(lastPrompt) > 10 * 60 * 1000) {
                sessionStorage.setItem(
                  `lastPrompt-${location.id}`,
                  now.toString()
                );
                setTimeout(() => showReportModal(location), 2000);
              }
            }
          });
        }
        // ========== END ADDED ==========

        // ========== ADDED: Function to calculate distance between two points ==========
        function getDistance(lng1, lat1, lng2, lat2) {
          const R = 6371e3; // Earth radius in meters
          const œÜ1 = (lat1 * Math.PI) / 180;
          const œÜ2 = (lat2 * Math.PI) / 180;
          const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180;
          const ŒîŒª = ((lng2 - lng1) * Math.PI) / 180;

          const a =
            Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
            Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

          return R * c;
        }
        // ========== END ADDED ==========

        // Add zoom & rotation controls
        map.addControl(new maplibregl.NavigationControl(), "top-right");

        // ========== REMOVED: Static BCIT marker - replaced with parking zone markers ==========
        // new maplibregl.Marker({ color: "#ff0000" })
        //   .setLngLat([-123.0016, 49.2505])
        //   .setPopup(
        //     new maplibregl.Popup().setHTML("<b>BCIT Burnaby Campus</b>")
        //   )
        //   .addTo(map);
        // ========== END REMOVED ==========

        // ========== ADDED: Draw parking zones on map ==========
        drawParkingZones();
        // ========== END ADDED ==========

        // Locate Me Button functionality
        const locateBtn = document.getElementById("locateBtn");
        console.log("Locate button:", locateBtn);

        locateBtn.addEventListener("click", () => {
          console.log("Locate button clicked");
          locateBtn.style.opacity = "0.6";
          setTimeout(() => (locateBtn.style.opacity = "1"), 200);

          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const userLngLat = [
                  position.coords.longitude,
                  position.coords.latitude,
                ];

                // ========== ADDED: Store user location and check nearby zones ==========
                currentUserLocation = userLngLat;
                checkNearbyZones(userLngLat[0], userLngLat[1]);
                // ========== END ADDED ==========

                if (userMarker) userMarker.remove();

                userMarker = new maplibregl.Marker({ color: "#007bff" })
                  .setLngLat(userLngLat)
                  .setPopup(
                    new maplibregl.Popup().setHTML("<b>You are here!</b>")
                  )
                  .addTo(map);

                map.flyTo({
                  center: userLngLat,
                  zoom: 16,
                  duration: 1500,
                });
              },
              (error) => {
                console.error("Geolocation error:", error);
                alert("Could not get your location.");
              }
            );
          } else {
            alert("Geolocation is not supported by your browser.");
          }
        });

        // Home Button functionality
        const homeIcon = document.querySelector(".home-icon");
        console.log("Home icon:", homeIcon);

        homeIcon.addEventListener("click", (e) => {
          e.preventDefault(); // Prevent default link behavior
          console.log("Home button clicked");

          // Fly back to BCIT
          map.flyTo({
            center: [-123.0016, 49.2505],
            zoom: 15,
            duration: 1500,
          });
        });

        // ========== Search Feature ==========
        const searchBtn = document.getElementById("searchBtn");
        const searchModal = document.getElementById("searchModal");
        const closeModal = document.getElementById("closeModal");
        const locationInput = document.getElementById("locationInput");
        const searchResults = document.getElementById("searchResults");

        console.log("Search button:", searchBtn);
        console.log("Search modal:", searchModal);

        searchBtn.addEventListener("click", () => {
          console.log("Search button clicked!");
          searchModal.style.display = "flex";
          locationInput.focus();
        });

        closeModal.addEventListener("click", () => {
          searchModal.style.display = "none";
          locationInput.value = "";
          searchResults.innerHTML = "";
        });

        searchModal.addEventListener("click", (e) => {
          if (e.target === searchModal) {
            searchModal.style.display = "none";
            locationInput.value = "";
            searchResults.innerHTML = "";
          }
        });

        let searchTimeout;
        locationInput.addEventListener("input", (e) => {
          clearTimeout(searchTimeout);
          const query = e.target.value.trim();

          if (query.length < 3) {
            searchResults.innerHTML = "";
            return;
          }

          searchTimeout = setTimeout(() => {
            searchLocation(query);
          }, 500);
        });

        async function searchLocation(query) {
          try {
            searchResults.innerHTML =
              '<div style="text-align: center; padding: 20px; color: #666;">Searching...</div>';

            const response = await fetch(
              `https://api.maptiler.com/geocoding/${encodeURIComponent(
                query
              )}.json?key=G8Dm1IT5QuwmIf5bQtVr&proximity=-123.0016,49.2505`
            );

            const data = await response.json();

            if (data.features && data.features.length > 0) {
              displayResults(data.features);
            } else {
              searchResults.innerHTML =
                '<div style="text-align: center; padding: 20px; color: #666;">No results found</div>';
            }
          } catch (error) {
            console.error("Search error:", error);
            searchResults.innerHTML =
              '<div style="text-align: center; padding: 20px; color: #666;">Error searching. Please try again.</div>';
          }
        }

        function displayResults(features) {
          searchResults.innerHTML = "";

          features.forEach((feature) => {
            const resultItem = document.createElement("div");
            resultItem.className = "search-result-item";

            const name = document.createElement("div");
            name.className = "result-name";
            name.textContent = feature.text || feature.place_name;

            const address = document.createElement("div");
            address.className = "result-address";
            address.textContent = feature.place_name;

            resultItem.appendChild(name);
            resultItem.appendChild(address);

            resultItem.addEventListener("click", () => {
              goToLocation(feature);
            });

            searchResults.appendChild(resultItem);
          });
        }

        function goToLocation(feature) {
          const [lng, lat] = feature.center;

          if (searchMarker) searchMarker.remove();

          searchMarker = new maplibregl.Marker({ color: "#22c55e" })
            .setLngLat([lng, lat])
            .setPopup(
              new maplibregl.Popup().setHTML(`<b>${feature.place_name}</b>`)
            )
            .addTo(map);

          map.flyTo({
            center: [lng, lat],
            zoom: 16,
            duration: 2000,
          });

          searchMarker.togglePopup();
          searchModal.style.display = "none";
          locationInput.value = "";
          searchResults.innerHTML = "";
        }

        // ========== ADDED: Report Modal close handlers ==========
        const closeReportModal = document.getElementById("closeReportModal");
        const reportModal = document.getElementById("reportModal");

        closeReportModal.addEventListener("click", () => {
          reportModal.style.display = "none";
        });

        reportModal.addEventListener("click", (e) => {
          if (e.target === reportModal) {
            reportModal.style.display = "none";
          }
        });
        // ========== END ADDED ==========
      });
    </script>
  </body>
</html>
