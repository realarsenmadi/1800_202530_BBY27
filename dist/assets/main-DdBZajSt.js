import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              */import{e as f,f as I,b as y,g as _,h as Y,o as le,i as de,d as x,a as ue,j as pe,q as me,w as fe,k as ye}from"./firebaseConfig-CLJOI27O.js";const F="9Bi8wM7l0P9Ijn8A56uS";document.addEventListener("DOMContentLoaded",function(){const O=document.getElementById("lastUpdatedDisplay"),Z=document.getElementById("map"),M=document.getElementById("locateBtn"),Q=document.querySelector(".home-icon"),G=document.getElementById("searchBtn"),d=document.getElementById("searchModal"),K=document.getElementById("closeModal"),L=document.getElementById("locationInput"),i=document.getElementById("searchResults"),B=document.getElementById("favouritesModal"),W=document.getElementById("closeFavourites"),w=document.getElementById("favouritesList"),J=document.getElementById("openFavourites"),V=document.querySelector(".filter-icon"),u=document.getElementById("filterModal"),X=document.getElementById("closeFilterModal"),ee=document.getElementById("applyFilter"),te=document.getElementById("clearFilter");let E=null;function c(e){const t=document.getElementById("toastNotification"),o=document.getElementById("toastMessage"),n=document.getElementById("toastCloseBtn");o.textContent=e,t.classList.add("show");const a=setTimeout(()=>{t.classList.remove("show")},4e3);n.onclick=()=>{t.classList.remove("show"),clearTimeout(a)}}function R(e){E=e,g.forEach(t=>{const o=`parking-layer-${t.id}`,n=`${o}-text`;if(!r.getLayer(o))return;const a=b(t);let s=!0;e==="available"?s=a==="#22c55e":e==="full"&&(s=a==="#ef4444"),r.setLayoutProperty(o,"visibility",s?"visible":"none"),r.setLayoutProperty(n,"visibility",s?"visible":"none")})}V.addEventListener("click",()=>{u.style.display="flex"}),X.addEventListener("click",()=>{u.style.display="none"}),u.addEventListener("click",e=>{e.target===u&&(u.style.display="none")}),ee.addEventListener("click",()=>{const e=document.querySelector('input[name="parkingFilter"]:checked');e&&(R(e.value),u.style.display="none")}),te.addEventListener("click",()=>{R(null),document.querySelectorAll('input[name="parkingFilter"]').forEach(e=>{e.checked=!1}),u.style.display="none"});const g=[{id:"A",name:"BCIT Parking Lot A",center:[-122.99837292626391,49.25205080109603],radius:80,reports:[]},{id:"B",name:"BCIT Parking Lot B",center:[-122.99830913222692,49.25105744299303],radius:80,reports:[]},{id:"D",name:"BCIT Parking Lot D",center:[-122.99917571760426,49.24816286829297],radius:80,reports:[]},{id:"E/F",name:"BCIT Parking Lot E/F",center:[-122.99917964985744,49.24717712468893],radius:70,reports:[],status:"closed"},{id:"L",name:"BCIT Parking Lot L",center:[-123.00086542868452,49.24504495669218],radius:80,reports:[]},{id:"M/N",name:"BCIT Parking Lot M/N",center:[-123.0023070002376,49.24485785029364],radius:90,reports:[]},{id:"Q",name:"BCIT Parking Lot Q",center:[-123.00290493253137,49.25422731483849],radius:80,reports:[]},{id:"5",name:"BCIT Parking Lot 5",center:[-123.00056274604528,49.25036650243376],radius:70,reports:[]},{id:"7",name:"BCIT Parking Lot 7 (Staff)",center:[-122.99929999762627,49.249023340019455],radius:70,reports:[]},{id:"12",name:"BCIT Parking Lot 12",center:[-122.99929066685925,49.24992438097292],radius:70,reports:[]}];let l=null,p=null,v=null,T=[];function b(e){if(e.status==="closed")return"#f59e0b";if(e.reports.length===0)return"#808080";const t=Date.now(),o=e.reports.filter(s=>t-s.timestamp<30*60*1e3);if(o.length===0)return"#808080";const n=o.filter(s=>s.status==="available").length,a=o.filter(s=>s.status==="full").length;return n>a?"#22c55e":"#ef4444"}function oe(){r.on("load",()=>{g.forEach(e=>{const t=`parking-${e.id}`,o=`parking-layer-${e.id}`;r.addSource(t,{type:"geojson",data:{type:"Feature",geometry:{type:"Point",coordinates:e.center},properties:{name:e.name,id:e.id}}}),r.addLayer({id:o,type:"circle",source:t,paint:{"circle-radius":20,"circle-color":b(e),"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),r.addLayer({id:`${o}-text`,type:"symbol",source:t,layout:{"text-field":e.id,"text-size":14,"text-font":["Open Sans Bold","Arial Unicode MS Bold"]},paint:{"text-color":"#ffffff"}}),r.on("click",o,()=>{e.status==="closed"?c(`${e.name} is currently closed for construction.`):$(e)}),r.on("mouseenter",o,()=>{r.getCanvas().style.cursor="pointer"}),r.on("mouseleave",o,()=>{r.getCanvas().style.cursor=""}),T.push({location:e,layerId:o})}),ne()})}function ne(){const e=Date.now()-18e5,t=me(I(y,"reports"),fe("timestamp",">",e));ye(t,o=>{console.log("Received update from Firebase"),g.forEach(n=>n.reports=[]),o.forEach(n=>{const a=n.data(),s=g.find(m=>m.id===a.locationId);s&&s.reports.push({status:a.status,timestamp:a.timestamp})}),g.forEach(n=>{r.getLayer(`parking-layer-${n.id}`)&&S(n.id)})})}function S(e){const t=T.find(n=>n.location.id===e);if(!t)return;const o=b(t.location);r.setPaintProperty(t.layerId,"circle-color",o)}function $(e){document.getElementById("modalLocationName").textContent=`Are parking spots available at ${e.name}?`,document.getElementById("reportModal").classList.add("active"),window.currentReportLocation=e}async function D(e){const t=window.currentReportLocation;if(!t)return;const o=f.currentUser;if(!o){c("You must be logged in to submit a report!");return}document.getElementById("reportModal").classList.remove("active");try{await Y(I(y,"reports"),{locationId:t.id,locationName:t.name,status:e,timestamp:Date.now(),userId:o.uid}),console.log("Report submitted successfully!");const a=x(y,"meta","lastUpdated");await ue(a,{time:new Date}),q()}catch(a){console.error("Full Firebase Error:",a),a.code==="permission-denied"?c("Error: You do not have permission to write to the database."):c(`Error submitting report: ${a.message}`)}}const A=document.querySelector(".report-button.available"),H=document.querySelector(".report-button.full"),U=document.getElementById("closeReportModal");A&&A.addEventListener("click",()=>D("available")),H&&H.addEventListener("click",()=>D("full")),U&&U.addEventListener("click",()=>{document.getElementById("reportModal").classList.remove("active")});function ae(e,t){window.mapIsReady&&g.forEach(o=>{if(o.status==="closed")return;if(re(e,t,o.center[0],o.center[1])<o.radius){const a=sessionStorage.getItem(`lastPrompt-${o.id}`),s=Date.now();(!a||s-parseInt(a)>10*60*1e3)&&(localStorage.setItem(`lastPrompt-${o.id}`,s.toString()),$(o))}})}function re(e,t,o,n){const s=t*Math.PI/180,m=n*Math.PI/180,h=(n-t)*Math.PI/180,P=(o-e)*Math.PI/180,C=Math.sin(h/2)*Math.sin(h/2)+Math.cos(s)*Math.cos(m)*Math.sin(P/2)*Math.sin(P/2);return 6371e3*(2*Math.atan2(Math.sqrt(C),Math.sqrt(1-C)))}async function q(){const e=x(y,"meta","lastUpdated"),t=await pe(e);O.textContent=t.exists()?"Last updated: "+t.data().time.toDate().toLocaleString():"Last updated: unknown"}q();const r=new maplibregl.Map({container:Z,style:`https://api.maptiler.com/maps/streets-v2/style.json?key=${F}`,center:[-123.0016,49.2505],zoom:15});r.on("load",()=>{window.mapIsReady=!0}),r.addControl(new maplibregl.NavigationControl,"top-right"),new maplibregl.Marker({color:"#ff0000"}).setLngLat([-123.0016,49.2505]).setPopup(new maplibregl.Popup().setHTML("<b>BCIT Burnaby Campus</b>")).addTo(r),M.addEventListener("click",()=>{M.style.opacity="0.6",setTimeout(()=>M.style.opacity="1",200),navigator.geolocation?v?(l?l.setLngLat(v):l=new maplibregl.Marker({color:"#007bff"}).setLngLat(v).setPopup(new maplibregl.Popup().setHTML("<b>You are here!</b>")).addTo(r),r.flyTo({center:v,zoom:16,duration:1500})):navigator.geolocation.getCurrentPosition(e=>{const t=[e.coords.longitude,e.coords.latitude];l?l.setLngLat(t):l=new maplibregl.Marker({color:"#007bff"}).setLngLat(t).setPopup(new maplibregl.Popup().setHTML("<b>You are here!</b>")).addTo(r),r.flyTo({center:t,zoom:16,duration:1500})},e=>{console.error("Location error:",e),c("Could not get your location.")},{enableHighAccuracy:!0,timeout:2e3,maximumAge:3e4}):c("Geolocation not supported.")}),navigator.geolocation&&navigator.geolocation.watchPosition(e=>{const t=[e.coords.longitude,e.coords.latitude];v=t,l&&l.setLngLat(t),ae(t[0],t[1])},e=>{console.log("Watch position error:",e)},{enableHighAccuracy:!0,maximumAge:1e4,timeout:5e3}),oe(),Q.addEventListener("click",e=>{e.preventDefault(),r.flyTo({center:[-123.0016,49.2505],zoom:15,duration:1500})}),G.addEventListener("click",()=>{d.style.display="flex",L.focus()}),K.addEventListener("click",()=>{d.style.display="none",L.value="",i.innerHTML=""}),d.addEventListener("click",e=>{e.target===d&&(d.style.display="none",L.value="",i.innerHTML="")});let N;L.addEventListener("input",e=>{clearTimeout(N);const t=e.target.value.trim();if(t.length<3){i.innerHTML="";return}N=setTimeout(()=>se(t),500)});async function se(e){try{i.innerHTML='<div style="text-align:center;padding:20px;color:#666;">Searching...</div>';const o=await(await fetch(`https://api.maptiler.com/geocoding/${encodeURIComponent(e)}.json?key=${F}&proximity=-123.0016,49.2505`)).json();o.features&&o.features.length>0?ie(o.features):i.innerHTML='<div style="text-align:center;padding:20px;color:#666;">No results found</div>'}catch(t){console.error(t),i.innerHTML='<div style="text-align:center;padding:20px;color:#666;">Error searching</div>'}}function ie(e){i.innerHTML="",e.forEach(t=>{const o=document.createElement("div");o.className="search-result-item";const n=document.createElement("div");n.className="result-name",n.textContent=t.text;const a=document.createElement("div");a.className="result-address",a.textContent=t.place_name;const s=document.createElement("button");s.textContent="⭐ Add Favourite",s.style.marginLeft="10px",s.addEventListener("click",async m=>{if(m.stopPropagation(),!f.currentUser)return c("Please log in first!");const h=I(y,"users",f.currentUser.uid,"favourites");if((await _(h)).docs.some(z=>z.data().address===t.place_name))return c("This address is already in your favourites!");await Y(h,{label:t.text,address:t.place_name}),c(`${t.text} was successfully added to your favourites!`),k()}),o.appendChild(n),o.appendChild(a),o.appendChild(s),o.addEventListener("click",()=>j(t)),i.appendChild(o)})}function j(e){try{console.log("Navigating to:",e.place_name);const[t,o]=e.center;p&&(p.remove(),p=null);const n=new maplibregl.Popup({offset:25}).setHTML(`<b>${e.place_name}</b>`),a=new maplibregl.Marker({color:"#22c55e"}).setLngLat([t,o]).setPopup(n).addTo(r);p=a,n.on("close",()=>{p===a&&(p.remove(),p=null)}),r.flyTo({center:[t,o],zoom:16,duration:2e3}),a.togglePopup(),d.style.display="none",L.value="",i.innerHTML=""}catch(t){console.error("Error in goToLocation:",t),d.style.display="none"}}le(f,()=>k());async function k(){if(w.innerHTML="",!f.currentUser){w.innerHTML="<li>Please log in to see favourites.</li>";return}const e=I(y,"users",f.currentUser.uid,"favourites");(await _(e)).forEach(o=>{const n=o.data(),a=document.createElement("li");a.innerHTML=`${n.label} – ${n.address} <button>❌</button>`,a.querySelector("button").addEventListener("click",async m=>{m.stopPropagation(),await de(x(y,"users",f.currentUser.uid,"favourites",o.id)),k()}),a.addEventListener("click",()=>{B.style.display="none",ce(n)}),w.appendChild(a)})}async function ce(e){try{const o=await(await fetch(`https://api.maptiler.com/geocoding/${encodeURIComponent(e.address)}.json?key=${F}`)).json();if(!o.features||o.features.length===0)return;j(o.features[0])}catch(t){console.error("Error going to favourite location",t)}}J.addEventListener("click",e=>{e.preventDefault(),B.style.display="block",k()}),W.addEventListener("click",()=>{B.style.display="none"}),document.getElementById("closeReportModal").addEventListener("click",()=>{document.getElementById("reportModal").classList.remove("active")})});
